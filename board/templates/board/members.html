<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Members</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-100 text-slate-900">
  {% csrf_token %}
  <header class="sticky top-0 z-40 border-b bg-white/90 backdrop-blur">
    <div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-3">
      <div class="flex items-center gap-3">
        <a href="{% url 'board:home' %}"><div class="h-8 w-8 rounded-lg bg-cyan-500 font-serif text-white p-2">Lini</div></a>
        <div class="font-semibold">{{ board.name }}</div>
        <span class="rounded-full bg-slate-100 px-2 py-0.5 text-xs text-slate-600">{{ role }}</span>
      </div>

      <div class="flex items-center gap-2">
        <button id="newListBtn" class="rounded-lg bg-slate-900 px-3 py-2 text-sm font-medium text-white hover:bg-slate-800">
          Add
        </button>
        <a class="rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50" href="{% url 'board:members_view' board.id %}">
          Members
        </a>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-4xl px-4 py-6">
    <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
      <div class="text-sm text-slate-600">
        Join code:
        <span class="font-medium text-slate-900">{{ board.join_code }}</span>
      </div>

      <div class="mt-2 text-xs text-slate-500">
        Only the creator is admin and can assign roles.
      </div>

      <div class="mt-4 overflow-hidden rounded-xl border border-slate-200">
        <div class="grid grid-cols-3 bg-slate-50 px-3 py-2 text-xs font-medium text-slate-600">
          <div>User</div>
          <div>Role</div>
          <div>Action</div>
        </div>

        {% for m in members %}
          <div class="grid grid-cols-3 items-center px-3 py-2 text-sm border-t border-slate-200">
            <div class="truncate">{{ m.user.username }}</div>
            <div class="text-slate-700">{{ m.role }}</div>
            <div>
              {% if role == "admin" and m.user_id != board.created_by_id %}
                <select class="roleSelect rounded-lg border border-slate-200 bg-white px-2 py-1 text-sm"
                        data-user-id="{{ m.user_id }}">
                  <option value="mentor" {% if m.role == "mentor" %}selected{% endif %}>mentor</option>
                  <option value="student" {% if m.role == "student" %}selected{% endif %}>student</option>
                  <option value="spectator" {% if m.role == "spectator" %}selected{% endif %}>spectator</option>
                </select>
                <button class="saveRoleBtn ml-2 rounded-lg bg-slate-900 px-3 py-1.5 text-sm text-white hover:bg-slate-800"
                        data-user-id="{{ m.user_id }}">
                  Save
                </button>
              {% else %}
                <span class="text-xs text-slate-500">No access</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </main>

  <script>
    function getCsrfToken() {
      const el = document.querySelector("input[name=csrfmiddlewaretoken]");
      return el ? el.value : "";
    }

    async function postJson(url, data) {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCsrfToken(),
        },
        body: JSON.stringify(data || {}),
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    document.querySelectorAll(".saveRoleBtn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const user_id = Number(btn.dataset.userId);
        const sel = document.querySelector('.roleSelect[data-user-id="' + user_id + '"]');
        const role = sel.value;

        await postJson("{% url 'board:member_set_role' board.id %}", { user_id, role });
        location.reload();
      });
    });
  </script>
</body>
</html>
